# 6️⃣7️⃣ Item 67 : 최적화는 신중히 하라

<br>

## 📌 목차
1. 최적화 격언 3가지
2. 팁 1. 빠른 프로그램보다는 좋은 프로그램을 작성하라
3. 팁 2. 성능을 제한하는 설계를 피하라
4. 팁 3. API를 설계할 때 성능에 주는 영향을 고려하라
5. 팁 4. 성능을 위해 API를 왜곡하는 건 매우 안 좋은 생각이다 
6. 팁 5. 각각의 최적화 시도 전후로 성능을 측정하라
7. 자바에서의 성능 측정 중요성
8. 결론

<br>

## ✅ 최적화 격언 3가지
`최적화와 관련된 격언 3가지`가 있다. 

1. (맹목적인 어리석음을 포함해) 그 어떤 핑계보다 `효율성이란 이름 아래 행해진 컴퓨팅 죄악`이 더 많다. (심지어 효율을 높이지도 못하면서) - 윌리엄 울프

<br>

2. (전체의 97% 정도인) 자그마한 효율성은 모두 잊자. `섣부른 최적화가 만악의 근원`이다. - 도널드 크누스

<br>

3. 최적화를 할 때는 다음 두 규칙을 따르라.
첫 번째, `하지 마라`
두 번째, (전문가 한정) 아직 하지 마라. 다시 말해, `완벽히 명백하고 최적화 되지 않은 해법을 찾을 때까지`는 하지 마라.- M.A. 잭슨

<br>

이 격언들을 보면 왜 이번 아이템 제목이 `‘최적화는 신중히 하라’` 인지 알 수 있다. 

이 격언들은 자바가 탄생하기 20년 전에 나온 것으로 `최적화의 어두운 진실`을 이야기 해주는 것이다. 

최적화는 좋은 결과보다는 `해로운 결과로 이어지기 쉽다`. 

`섣불리 최적화 진행`하면 특히 더 해로운 결과로 이어지기 쉽다. 

최적화를 잘못 하면 `빠르지도 않고 제대로 동작하지도 않으면서 수정하기는 어려운 SW를 탄생`시키는 것이다. 

<br>

그렇다면 어떻게 최적화를 `신중히 진행해야 하는지 팁`들을 살펴보자. 

<br>

## 1️⃣ 팁 1. 빠른 프로그램보다는 좋은 프로그램을 작성하라

이 팁에서 말하고자 하는 것은 `성능 때문에 견고한 구조 즉 아키텍처를 희생하지 말라`는 것이다. 

<br>

좋은 프로그램이지만 원하는 성능이 나오지 않는다면 그 `아키텍처 자체가 최적화 할 수 있는 길을 안내`해줄 것이다. 

좋은 프로그램을 완성할 때까지 성능 문제를 무시하라는 뜻이 아니다. 

`구현상의 문제는 나중에 최적화해서 해결`할 수 있다. 

하지만 `아키텍처의 결함이 성능을 제한하는 상황이라면 시스템 전체를 다시 작성하지 않고는 해결하기 불가능`할 수 있다. 

<br>

따라서 설계 단계에서 성능을 반드시 염두에 두어서 `성능에 문제가 없는 좋은 아키텍처를 설계`해 놔야 한다는 것이다. 

<br>

## 2️⃣ 팁 2. 성능을 제한하는 설계를 피하라

위의 팁에 이어서 두번째 팁은 `성능을 제한하는 설계를 피하라는 것`이다.

<br>

`완성 후 변경하기 가장 어려운 설계 요소`가 있는데 API, 네트워크 프로토콜, 영구 저장용 데이터 포맷 등이 있다. 

이런 것들은 컴포넌트끼리, 혹은 외부 시스템과의 소통을 하기 때문에 변경하려면 굉장히 어렵거나 불가능할 수도 있다. 

`이런 부분에서 성능 저하가 일어나고 있다면 시스템 성능을 심각하게 제한`할 수 있다. 

<br>

따라서 이렇게 `변경하기 어려운 요소에는 성능을 제한하는 설계를 피하라`는 것이다. 

<br>

## 3️⃣ 팁 3. API를 설계할 때 성능에 주는 영향을 고려하라

세번째 팁은 `API를 설계할 때 성능에 주는 영향을 고려`하라는 것이다. 

<br>

예를 들어 인터페이스가 있는데 굳이 구현 타입을 사용해서 API를 설계하는 것이다. 

이렇게 되면 `특정 구현체에 종속되게 하여 나중에 더 빠른 구현체가 나오더라도 이용하지 못하게 된다`. 

이외에도 이펙티브 자바를 하면서 배운 많은 `팁들을 상기하면서 API를 설계`하라는 것이다. 

<br>

이렇게 `성능에 주는 영향을 고려하지 않고 API를 설계한 것`이 자바에도 있다. 

java.awt.Component 클래스의 getSize 메서드가 예시이다. 

이 메서드는 Dimension 인스턴스를 반환하는데 Dimension이 가변이라 getSize를 호출하면 모든 곳에서 Dimension 인스턴스를 새로 생성해야 한다. 

getSize를 굉장히 많이 호출하게 되면 분명히 성능에도 영향이 있을 것이다. 

<br>

이렇게 `잘못 내린 API 설계 결정의 폐해를 아직도 감내`하고 있는 것이다.  

따라서 API 설계할 때 성능에 주는 영향을 고려해서 설계해야 한다는 것이다. 

<br>

## 4️⃣ 팁 4. 성능을 위해 API를 왜곡하는 건 매우 안 좋은 생각이다

위의 팁과 이어져서 네번째 팁은 `성능을 위해 API를 왜곡하지 말라는 것`이다. 

<br>

잘 설계된 API는 성능도 좋은게 보통이다. 

따라서 `설계를 잘하다 보면 성능은 따라오는 것`이다. 

그런데 성능을 위해 API를 왜곡하고 이상한 설계를 진행하면 문제가 더 커지게 된다. 

<br>

API를 왜곡하도록 만든 그 `성능 문제는 다음 버전에서 사라질 수도 있다`. 

하지만 왜곡된 API와 이 `API를 지원하는 곳에서는 고통이 영원히 계속`되는 것이다. 

<br>

그래서 처음 설계할 때 잘 설계하고 성능을 위해 설계, API를 왜곡하지 말라는 것이다. 

신중하게 설계해 깨끗하고 명확하고 `멋진 구조를 갖춘 프로그램을 완성한 다음에야 최적화를 고려`해볼 차례가 된다. 

<br>

## 5️⃣ 팁 5. 각각의 최적화 시도 전후로 성능을 측정하라

다섯번째 팁은 각각의 `최적화 시도 전후로 성능을 측정`하라는 것이다. 

<br>

최적화 기법을 시도하고 성능을 측정했을 때 성능이 좋아질수도, 안 좋아질수도 있다. 

최적화 기법을 시도하면 `늘 성능이 좋아질 것 같은데 그렇지 않을 수도 있다`는 것이다. 

<br>

왜 그런가 하면 주요 원인은 프로그램에서 `시간을 잡아먹는 부분을 추측하기 어렵기 때문`이다. 

내가 시간을 잡아 먹는 부분이라고 짐작한 부분이 사실 성능에 별다른 영향을 주지 않는 곳일 수도 있다. 

이렇게 되면 최`적화를 시도해도 성능 차이가 없거나 더 안 좋아질 수 있는 것`이다. 

<br>

일반적으로 `90%의 시간을 단 10%의 코드에서 사용`한다고 한다. 

그래서 시간을 많이 사용하는 코드를 잘 알아야 하는데 찾기가 어렵다. 

이런 문제를 해결하기 위해 `프로파일링 도구`라는 것이 있다. 

<br>

프로파일링 도구는 최적화를 어디에 집중해야 할지 찾는데 도움을 준다. 

이런 도구는 런타임 정보를 제공해서 어디에 최적화를 해야 하는지 심지어 `알고리즘을 변경해야 한다는 사실`도 알려준다고 한다. 

시스템 규모가 커질수록 프로파일러가 더 중요해진다고 한다. 

<br>

프로파일러 도구 외에도 jmh라는 도구도 알면 좋다고 한다.

자바 코드의 상세한 성능을 알기 쉽게 보여주는 마이크로 벤치마킹 프레임워크라고 한다.  

<br>

## ❗ 자바에서의 성능 측정 중요성

최적화 시도 전후의 성능 측정은 C, C++ 같은 전통적인 언어에서도 중요하지만 `성능 모델이 덜 정교한 자바에서 중요성`이 더욱 크다. 

왜 자바에서 성능 측정이 더 중요한지 알아보자. 

<br>

1. **자바는 프로그래머가 작성하는 코드와 CPU에서 수행하는 명령 사이의 추상화 격차가 크다.**
    1. 그래서 최적화로 인한 `성능 변화를 일정하게 예측하기 더 어렵다`. 
    2. 그래서인지 최적화와 관련해 `이상한 미신`들이 떠돌아 다닌다. 

<br>

2.  **자바의 성능 모델은 정교하지 않을뿐더러 구현 시스템, 릴리스, 프로세서마다 차이가 있다.**
    1. 자바 프로그램을 여러 가지 자바 플랫폼이나 여러 하드웨어 플랫폼에서 구동한다면 `최적화의 효과를 각각에서 측정`해야 한다. 
    2. 다른 구현 혹은 하드웨어 플랫폼 사이에서 `성능을 타협해야 하는 상황` 마주할 수도 있다. 

<br>

3. **자바가 발전하면서 자바 소프트웨어 스택의 모든 요소가 훨씬 복잡해졌다.** 
    1. 프로세서부터 가상머신, 라이브러리, 그리고 자바가 수행되는 `하드웨어 종류도 다양`해졌다. 

<br>

이러한 문제점들이 있어 자바 프로그램의 `성능 예측이 더 어려워진 것`이다. 

그래서 자바에서는 성능 측정이 더 중요한 것이다. 

<br>

## ‼ 결론

- 빠른 프로그램을 작성하려 안달하지 말자.
    - 좋은 프로그램을 작성하다 보면 성능은 따라오게 마련이다.
- 시스템을 설계할 때는 성능을 염두에 두어야 한다.
    - 특히 API, 네트워크 프로토콜, 영구 저장용 데이터 포맷 설계할 때 더 염두에 두어야 한다.
- 시스템 구현 완료했다면 성능을 측정해보자.
    - 충분히 빠르면 잘한 것으로 끝이다.
    - 충분히 빠르지 않다면 프로파일러를 사용해 문제의 원인이 되는 지점 찾아 최적화 수행하자.
- 최적화 수행할 때 먼저 어떤 알고리즘 사용했는지 살펴보자.
    - 알고리즘을 잘못 골랐다면 다른 저수준 최적화는 아무리 해봐야 소용이 없다.
- 성능을 만족할 때까지 이 과정 반복하자.
- 프로그램의 모든 변경 후에는 성능을 측정하자.